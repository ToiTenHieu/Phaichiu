{% extends "basee.html" %} {% block content %}
<!-- Qu·∫£n L√Ω S√°ch Section -->
{% include "accounts/managebook.html" %}
<!-- Qu·∫£n L√Ω M∆∞·ª£n/Tr·∫£ Section -->
{% include "accounts/manageBorrow.html" %}

<!-- Qu·∫£n L√Ω Ng∆∞·ªùi D√πng Section -->
<div
  id="quanLyNguoiDung"
  class="section bg-white rounded-xl shadow-lg p-6 mb-6 card-hover transition-all duration-300 hidden"
>
  <h2 class="text-2xl font-bold text-purple-600 mb-6 flex items-center">
    üë• Qu·∫£n L√Ω Ng∆∞·ªùi D√πng
  </h2>

  <div class="grid md:grid-cols-2 gap-6">
    <!-- Form th√™m ng∆∞·ªùi d√πng -->
    <div class="bg-purple-50 rounded-lg p-6">
      <h3 class="text-lg font-semibold text-purple-800 mb-4">
        Th√™m Ng∆∞·ªùi D√πng
      </h3>
      <form method="post" class="space-y-4">
        {% csrf_token %}
        <!-- username -->
        <input
          type="text"
          name="username"
          placeholder="T√™n ƒëƒÉng nh·∫≠p"
          class="w-full px-4 py-2 border border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          required
        />

        <!-- password -->
        <input
          type="password"
          name="password"
          placeholder="M·∫≠t kh·∫©u"
          class="w-full px-4 py-2 border border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          required
        />

        <!-- name -->
        <input
          type="text"
          name="name"
          placeholder="H·ªç v√† t√™n"
          class="w-full px-4 py-2 border border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          required
        />

        <!-- occupation -->
        <input
          type="text"
          name="occupation"
          placeholder="Ngh·ªÅ nghi·ªáp (VD: Sinh vi√™n, Gi·∫£ng vi√™n)"
          class="w-full px-4 py-2 border border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        />

        <!-- address -->
        <input
          type="text"
          name="address"
          placeholder="ƒê·ªãa ch·ªâ"
          class="w-full px-4 py-2 border border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        />

        <!-- date_of_birth -->
        <input
          type="date"
          name="date_of_birth"
          class="w-full px-4 py-2 border border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          required
        />

        <!-- gender -->
        <select
          name="gender"
          class="w-full px-4 py-2 border border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          required
        >
          <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
          <option value="male">Nam</option>
          <option value="female">N·ªØ</option>
          <option value="other">Kh√°c</option>
        </select>
        <input
          type="email"
          name="email"
          placeholder="Email"
          class="w-full px-4 py-2 border rounded-lg"
          required
        />
        <!-- phone -->
        <input
          type="tel"
          name="phone"
          placeholder="S·ªë ƒëi·ªán tho·∫°i"
          class="w-full px-4 py-2 border border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
        />

        <button
          type="submit"
          class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 font-semibold"
        >
          ‚ûï Th√™m Ng∆∞·ªùi D√πng
        </button>
      </form>
    </div>

    <!-- Danh s√°ch ng∆∞·ªùi d√πng -->
    <div class="max-w-4xl mx-auto mt-8 space-y-4">
      <h2 class="text-2xl font-bold text-purple-700 mb-6 border-b pb-2">
        Danh s√°ch ng∆∞·ªùi d√πng
      </h2>
      {% if messages %}
      <div id="messages-container" class="container mx-auto mt-4">
        {% for message in messages %}
        <div
          class="p-4 mb-4 rounded-lg transition-opacity duration-500 {% if message.tags == 'success' %}bg-green-100 text-green-800 {% elif message.tags == 'error' %}bg-red-100 text-red-800 {% else %}bg-gray-100 text-gray-800{% endif %}"
        >
          {{ message }}
        </div>
        {% endfor %}
      </div>

      <script>
        setTimeout(() => {
          const container = document.getElementById("messages-container");
          if (container) {
            container.style.opacity = "0"; // l√†m m·ªù d·∫ßn
            setTimeout(() => container.remove(), 500); // xo√° h·∫≥n sau khi m·ªù
          }
        }, 3000); // 3 gi√¢y
      </script>
      {% endif %} {% for user in users %}
      <div
        class="bg-gradient-to-r from-purple-50 to-white p-5 rounded-xl shadow hover:shadow-md transition duration-200 border border-purple-100"
      >
        <div class="flex justify-between items-start">
          <div>
            <h4 class="text-lg font-semibold text-gray-800 mb-1">
              {{ user.user.username }}
              <span class="text-gray-500">‚Äì {{ user.get_full_name }}</span>
            </h4>
            <p class="text-sm text-gray-600">
              üìß <span class="font-medium">{{ user.user.email }}</span>
            </p>
            <p class="text-sm text-gray-600 mt-1">
              üìû {{ user.phone }}
              <span class="mx-2">|</span>
              Lo·∫°i: {% if user.role == 'user' %}
              <span class="font-medium text-blue-600">Sinh vi√™n</span>
              {% elif user.role == 'librarian' %}
              <span class="font-medium text-green-600">Th·ªß th∆∞</span>
              {% else %}
              <span class="font-medium">{{ user.role }}</span>
              {% endif %}
            </p>
          </div>
          <div class="flex space-x-2">
            <a
              href="{% url 'edit_user' user.id %}?section=quanLyNguoiDung"
              class="text-xs bg-yellow-500 text-white px-3 py-1 rounded-full hover:bg-yellow-600 transition"
            >
              ‚úèÔ∏è S·ª≠a
            </a>
<!-- Button X√≥a Ng∆∞·ªùi D√πng -->
<button
  type="button"
  onclick="deleteUser({{ user.id }})"
  class="text-xs bg-red-500 text-white px-3 py-1 rounded-full hover:bg-red-600 transition"
>
  üóëÔ∏è X√≥a
</button>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function deleteUser(userId) {
    Swal.fire({
        title: "‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn?",
        text: "Ng∆∞·ªùi d√πng s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn v√† kh√¥ng th·ªÉ kh√¥i ph·ª•c!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "üóëÔ∏è X√≥a",
        cancelButtonText: "‚ùå H·ªßy",
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/accounts/api/users/${userId}/delete/`, {
                method: "DELETE",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"), // d√πng CSRF n·∫øu b·∫≠t
                    "X-Requested-With": "XMLHttpRequest",
                },
            })
            .then(response => {
                if (!response.ok) throw new Error("Kh√¥ng th·ªÉ xo√° ng∆∞·ªùi d√πng");
                return response.json();
            })
            .then(data => {
                Swal.fire({
                    title: "ƒê√£ x√≥a!",
                    text: data.message || "Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng.",
                    icon: "success",
                    confirmButtonText: "OK",
                }).then(() => {
                    location.reload();
                });
            })
            .catch(error => {
                Swal.fire("L·ªói!", "Kh√¥ng th·ªÉ xo√° ng∆∞·ªùi d√πng. Vui l√≤ng th·ª≠ l·∫°i!", "error");
            });
        }
    });
}
</script>

            </form>
          </div>
        </div>
      </div>
      {% empty %}
      <p class="text-sm text-gray-500 italic">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o.</p>
      {% endfor %}
    </div>
  </div>
</div>
<!-- Ki·ªÉm Tra T√¨nh Tr·∫°ng Section -->
{% include "accounts/bookstatistics.html" %}

<!-- Modal Th√¥ng Tin C√° Nh√¢n (·∫®n) -->
<div
  class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center"
>
  <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4 fade-in">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-blue-600">üë§ Th√¥ng Tin C√° Nh√¢n</h3>
      <button class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
    </div>

    <form class="space-y-4">
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2"
          >Username</label
        >
        <input
          type="text"
          value="admin"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          required
        />
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2"
          >Password</label
        >
        <div class="relative">
          <input
            type="password"
            value="123456"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10"
            required
          />
          <button
            type="button"
            class="absolute right-3 top-2.5 text-gray-500 hover:text-gray-700"
          >
            üëÅÔ∏è
          </button>
        </div>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2"
          >H·ªç v√† T√™n</label
        >
        <input
          type="text"
          value="Nguy·ªÖn VƒÉn A"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          required
        />
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2"
          >Email</label
        >
        <input
          type="email"
          value="admin@thuvien.com"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          required
        />
      </div>

      <div class="flex space-x-3 pt-4">
        <button
          type="submit"
          class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors font-semibold"
        >
          üíæ L∆∞u Thay ƒê·ªïi
        </button>
        <button
          type="button"
          class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors font-semibold"
        >
          ‚ùå H·ªßy
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %}
